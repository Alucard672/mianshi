# 腾讯云部署与云数据库配置（云托管 + MySQL）

这份文档按“最短可跑”为目标：一个云托管服务同时提供前端页面和后端 API，数据库使用腾讯云 MySQL。

## 1. 你截图的页面是什么

你现在打开的是 **“新建 MySQL 数据库连接配置”**。

它不是“创建数据库实例”，而是给云开发/云托管配置一个 **“连接到某个已经存在的 MySQL”** 的连接信息：
- 你必须先在腾讯云创建一个 MySQL（TencentDB for MySQL 或 CloudBase SQL）。
- 然后把 MySQL 的 `主机/端口/库名/账号/密码` 填到这里。

## 2. 是否需要建 VPC

两种方式，推荐第 1 种：

### 方式 1（推荐）：内网（VPC）连接
- 云托管服务和 MySQL 放在 **同地域同 VPC**。
- 不开公网数据库，安全性更好。

### 方式 2：公网连接
- 给 MySQL 开启公网地址，并配置白名单允许云托管出口 IP。
- 配置更快，但安全性依赖白名单。

你之前打开的“新建 VPC”页面，对应的是 **方式 1**。

## 3. 创建 VPC（你截图那页怎么填）

建议填写：
- 所属地域：和你的云托管环境保持一致（你截图是上海，就选上海）
- VPC 名称：`mianshi-vpc`
- IPv4 CIDR：保持默认 `10.0.0.0/16` 即可
- 子网名称：`mianshi-subnet`
- 子网 CIDR：`10.0.0.0/24`
- 可用区：选一个即可（后面 MySQL 也选同可用区更稳）

创建完成后，记下：
- VPC ID
- 子网 ID

## 4. 创建云 MySQL（云 SQL 还没建立）

你可以用两类 MySQL（二选一）：
- **腾讯云 云数据库 MySQL（TencentDB）**：通用、功能最全。
- **CloudBase SQL（如果你的云开发控制台里提供）**：更贴近云开发生态。

不管用哪个，创建时关键点一致：
- 地域：同上（上海）
- 网络：选择刚建的 `mianshi-vpc` + `mianshi-subnet`
- 账号/密码：设置一个强密码（不要用 111111）
- 初始化库：创建库名 `mianshi`（或你想要的名字）
- 字符集：`utf8mb4`

创建后得到：
- 内网地址（host）
- 端口（一般 3306）

## 5. 在云托管里部署（前后端合并一个服务）

你的仓库已经支持“服务端同时托管前端 dist”。

### 5.1 选择部署方式

推荐：云托管选择 **Dockerfile** 构建（仓库根目录已加入 `Dockerfile`）。

### 5.2 端口（你说“监听端口没找到”）

服务端代码读取端口：`process.env.PORT || 3001`。

在云托管的服务配置里：
- 如果有“监听端口/容器端口”：填 `3001`
- 如果是通过环境变量注入端口：把环境变量 `PORT=3001`

二选一即可。

## 6. 云托管环境变量（必须配）

在云托管服务的“环境变量”里新增（按你的 MySQL 信息填写）：

- `DB_HOST`：MySQL 内网地址
- `DB_PORT`：`3306`
- `DB_USER`：数据库用户名
- `DB_PASS`：数据库密码
- `DB_NAME`：`mianshi`
- `PORT`：`3001`

建议再加：
- `DB_MIGRATE_ON_START`：`1`  （每次启动自动跑迁移，避免 `/api/admin/jobs` 等接口 500）
- `APP_BASE_URL`：你的线上域名（用于生成分享链接），例如 `https://xxx.tcloudbaseapp.com`
- `CORS_ORIGINS`：你的线上域名（逗号分隔），例如 `https://xxx.tcloudbaseapp.com`

## 7. 数据库表怎么建

项目内置迁移脚本，并且我已经加了启动时自动迁移开关：
- 只要你在云托管设置 `DB_MIGRATE_ON_START=1`
- 且 DB 环境变量正确

服务启动时会自动执行迁移，表会自动创建。

## 8. 你截图“新建 MySQL 数据库连接配置”怎么填

当你已经有 MySQL 实例后，按下列填：
- 数据库类型：`mysql`
- SQL 配置名称：随便取，例如 `mianshi-mysql`
- 标识：唯一字符串，例如 `mianshi_mysql`
- 接入方式：
  - 如果你走公网：选“通过公网 IP/域名对接”，主机填公网地址
  - 如果你走 VPC：控制台里通常会提供“私网/VPC 对接”（不同入口名称可能不一样）
- 主机：你的 MySQL 地址（内网或公网）
- 端口：`3306`
- 默认数据库名：`mianshi`
- 用户名/密码：对应账号

## 9. 常见报错快速定位

### 9.1 `Missing required env var: DB_HOST`
- 云托管/本地没有配置 DB 环境变量。

### 9.2 `/api/admin/jobs` 500
- 99% 是迁移没跑或 DB 权限不够。
- 直接把 `DB_MIGRATE_ON_START=1` 打开并重启服务。

